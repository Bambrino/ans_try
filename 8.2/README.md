## 08.02 Работа с Playbook

Сделано:
 - docker-compose на два контейнера (clickhouse-01 и vector-01)
 - добавлено в inventory prod.yml (connector docker)
 - добавлены переменные для vector
 - изменено в исодной части установки clickhouse: 
 
    1) добавлено условие по хостнейму
    2) часть тасок по установке clickhouse (после блока с resque) объединена в блок (один тэг, одно условие)
    3) так как работа с докером (нюанс с systemd) изменена таска с перезапуском clockhouse-server (сделано через модуль command)
    4) добавлен тэг clickhouse
 
 playbook site.yml
 - добавлен блок с тасками для установки vector на хост vector-01
 - дабавлен тэг vector
 - выполянется скачивание rpm и установка через yum
 - запрашивается через shell и выводится через debug версия vector
 
 playbook site2.yml
 - в данном случае (чтобы видеть diff) установка выполняется: 
    1) скачивается архив
    2) создается директория /opt/vector
    3) распаковывается в эту директорию архив
    4) /usr/bin/ создается линк на vector
    5) запрашивается через shell и выводится через debug версия vector


<details>
    <summary> Вывод запуска site2.yml --diff </summary>

```diff
$ ansible-playbook -i ./inventory/prod.yml site2.yml --diff

PLAY [Install Clickhouse] ********************************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ***********************************************************************************************************************************************************************************************************************************************************
ok: [vector-01]
ok: [clickhouse-01]

TASK [Get clickhouse distrib] ****************************************************************************************************************************************************************************************************************************************************
skipping: [vector-01]
changed: [clickhouse-01] => (item=clickhouse-client)
changed: [clickhouse-01] => (item=clickhouse-server)
failed: [clickhouse-01] (item=clickhouse-common-static) => {"ansible_loop_var": "item", "changed": false, "dest": "./clickhouse-common-static-22.3.3.44.rpm", "elapsed": 0, "item": "clickhouse-common-static", "msg": "Request failed", "response": "HTTP Error 404: Not Found", "status_code": 404, "url": "https://packages.clickhouse.com/rpm/stable/clickhouse-common-static-22.3.3.44.noarch.rpm"}

TASK [Get clickhouse distrib] ****************************************************************************************************************************************************************************************************************************************************
changed: [clickhouse-01]

TASK [Install clickhouse packages] ***********************************************************************************************************************************************************************************************************************************************
skipping: [vector-01]
changed: [clickhouse-01]

TASK [restart clickhouse-server] *************************************************************************************************************************************************************************************************************************************************
skipping: [vector-01]
changed: [clickhouse-01]

TASK [Create database] ***********************************************************************************************************************************************************************************************************************************************************
skipping: [vector-01]
changed: [clickhouse-01]

TASK [Download vector rpm] *******************************************************************************************************************************************************************************************************************************************************
skipping: [clickhouse-01]
changed: [vector-01]

TASK [Create vector directory] ***************************************************************************************************************************************************************************************************************************************************
skipping: [clickhouse-01]
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/opt/vector",
-    "state": "absent"
+    "state": "directory"
 }

changed: [vector-01]

TASK [Unpack archive] ************************************************************************************************************************************************************************************************************************************************************
skipping: [clickhouse-01]
changed: [vector-01]

TASK [Add vector to bin] *********************************************************************************************************************************************************************************************************************************************************
skipping: [clickhouse-01]
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/usr/bin/vector",
-    "state": "absent"
+    "state": "link"
 }

changed: [vector-01]

TASK [Vector version] ************************************************************************************************************************************************************************************************************************************************************
skipping: [clickhouse-01]
changed: [vector-01]

TASK [ansible.builtin.debug] *****************************************************************************************************************************************************************************************************************************************************
skipping: [clickhouse-01]
ok: [vector-01] => {
    "vector_info.stdout": "vector 0.22.2 (x86_64-unknown-linux-gnu 0024c92 2022-06-15)"
}

PLAY RECAP ***********************************************************************************************************************************************************************************************************************************************************************
clickhouse-01              : ok=5    changed=4    unreachable=0    failed=0    skipped=6    rescued=1    ignored=0   
vector-01                  : ok=7    changed=5    unreachable=0    failed=0    skipped=4    rescued=0    ignored=0 
```
</details>

Повторный запуск различий не находит (индемпотентность)
